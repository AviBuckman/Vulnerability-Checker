import csv
from db_handler import DBHandler
from CSV_handler import CSVHandler

from defs import *

TITLES = ["Host", "RELRO", "Canary", "NX", "PIE", "CFI", "SafeStack",
          "RPATH", "RUNPATH", "Symbols", "Fortify", 'Fortified', "Fortiable", "file"]
FILE_NAME = "Checksec.csv"


def findChecksecinDB(package, rowlist):
    query = f"SELECT {CHECKSEC} from {VULNERABILITY_TABLE_NAME} where {PACKAGE} = '{package}' and {CHECKSEC} != 'NULL'"
    db = DBHandler()
    result = db._execute_select(query)
    rowlist.extend(result)


def checksecTocsv(packages: list):
    cs = CSVHandler()
    cs.create_table(FILE_NAME, TITLES)
    rows = list()
    for p in packages:
        findChecksecinDB(p, rows)
    rows = list(map(lambda x: x[0].split(','), rows))
    print("d")
    cs.insertRows(FILE_NAME, rows)


p = ['dbus-tools-1.12.8-9.el8.x86_64']
checksecTocsv(p)
