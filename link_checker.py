import subprocess, re , os

def get_installed_libraries():
    row_pattern = r'ii\s+\S+\s+\S+\s+\S+'
    result = subprocess.run("dpkg -l",shell=True, stdout=subprocess.PIPE).stdout.decode('utf-8')
    rows = re.findall(row_pattern,result)
    library_list = list(map(row_to_dictionary,rows))
    return library_list

def row_to_dictionary(row):
    field_pattern = r'\s+\S+\s+\S+\s+\S+'
    str_without_i = re.findall(field_pattern,row)[0]
    field_list= re.split(r'\s+',str_without_i)
    lib_dict = {"name":field_list[1] , "version": field_list[2], "architecture": field_list[3]}
    return lib_dict


def scan_library(library,counter_diff_Links):
    library_name = library["name"]
    output = subprocess.run(['dpkg', '-L', library_name], stdout=subprocess.PIPE).stdout.decode('utf-8')
    path_list = output.split("\n")
    path_list_filtered = list(filter(lambda x: os.path.isfile(x) ,path_list))
    for path in path_list_filtered:
        checkPath(path, library_name,counter_diff_Links)
    # pass lists to respective functions
    return counter_diff_Links

def checkPath(path, package_name, counter_diff_Links):
    path = path.strip(' \t\n\r')
    if len(path)>0:
        command = "file "+path
        file_info = subprocess.run(command,shell=True, stdout=subprocess.PIPE).stdout.decode('utf-8')
        file_type = get_file_type(file_info)
        if (file_type == "LINK"):
            command="readlink -f "+path
            pointed_to = subprocess.run(command, shell=True,stdout=subprocess.PIPE).stdout.decode('utf-8')
            # print(pointed_to)
            command = "dpkg -S " + pointed_to
            package_name_pointed_to =  subprocess.run(command, shell=True,stdout=subprocess.PIPE).stdout.decode('utf-8')
            package_name_pointed_to=package_name_pointed_to.split(':')[0]
            if(package_name != package_name_pointed_to):
                counter_diff_Links=counter_diff_Links+1
    return  counter_diff_Links



def get_file_type(file_info):
    if "text" in file_info:
        #ascii text executable not caught here
        #generate list of file() outputs, sort, examine --> fine tune the search
        return "TEXT"
    elif "ELF" in file_info:
        return "ELF"
    elif "symbolic link" in file_info:
        return "LINK"
    else:
        return None

def main_func():
    counter_diff_Links = 0
    libs = get_installed_libraries()
    for lib in libs:
        counter_diff_Links = scan_library(lib,counter_diff_Links)
    print(counter_diff_Links)

main_func()