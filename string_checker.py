import glob, os, sys, subprocess,re
from csv import reader
from db_handler import *
# dictionary keys
PACKAGE = "package"
FULL_PATH = "full_path"
LINE="line"
DIRECTORY = "directory"
FILE_NAME = "file_name"
FILE_OUTPUT = "file_info_output"
MD5="md5"
SHA1 ="sha1"
SHA256 = "sha256"
B2 = "b2"
STRINGS = "strings"
READELF = "readelf"
VULNERABLE_FUNC= "vulnerable_functions"
SECRET_KEYS = "secret_keys"
columnName = [PACKAGE, FULL_PATH, DIRECTORY, FILE_NAME, FILE_OUTPUT, MD5, SHA1, SHA256, B2 , STRINGS,  READELF, VULNERABLE_FUNC, SECRET_KEYS]


def findKeyWordsInFile(output: str, secretKeysList: list):
    """This function reads a string from a text file and searching for secret-keys in the string. 

    Args:
        output (str): string from text file.
        secretKeysList (list): list of secret keys.

    Returns:
        set : The secret-keys found
        set: The lines that contain the secret-keys.
    """
    txt = output
    lines = txt.split("\n")
    found = set()
    linesToAdd=set()
    for line in lines:
        for func_word in secretKeysList:
            if re.search(func_word , line, re.IGNORECASE):
                found.add(func_word)
                linesToAdd.add(line)

    return found, linesToAdd

def loadKeysFromCsv():
    """This finction load the secret-keys from csv file called secretKeys.csv

    Returns:
        list: list of seceret keys.
    """
    with open('secretKeys.csv', 'r') as read_obj:
        csv_reader = reader(read_obj)
        list_of_rows = list(csv_reader)
        return list(map(lambda x: x[0], list_of_rows))


def txtFileChecker(path: str, package: str, package_manager: str, version: str):
    """This function get info about text file , extracting the string and checks if the file contains secre-keys in it.

    Args:
        path (str): path to text file 
        package (str): The package in which the file is located
        package_manager (str): The command. Depends on the type of linux system 
        version (str):The package version.

    Returns:
        dictionary : if secret-keys found- with keys: strings, secret_keys.
                    if no secret-keys found -None.
        set: The lines that contain the secret-keys.

    """
    secretKeysList = loadKeysFromCsv()
    file_dict = dict()
    strings_command = f"{STRINGS} {path}"
    strings_output = subprocess.run(strings_command, shell=True, stdout=subprocess.PIPE).stdout.decode('utf-8')
    foundKeys, lines = findKeyWordsInFile(strings_output, secretKeysList)
    if len(foundKeys) > 0:
        file_dict[STRINGS] = strings_output
        file_dict[SECRET_KEYS] = str(foundKeys)
    else:
        file_dict = None
    
    return file_dict, lines
