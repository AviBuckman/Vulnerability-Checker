import sys
import os
import atexit
import pyodbc as driver

PACKAGE = "package"
PACKAGE_MANAGER = "package_manager"
VERSION = "version"
FULL_PATH = "full_path"
DIRECTORY = "directory"
FILE_NAME = "file_name"
FILE_OUTPUT = "file_info_output"
MD5 = "md5"
SHA1 = "sha1"
SHA256 = "sha256"
B2 = "b2"
STRINGS = "strings"
READELF = "readelf"
VULNERABLE_FUNC = "vulnerable_functions"
SECRET_KEYS = "secret_keys"
CHECKSEC = "checksec"
LINE = "line"

class_DB_name = 'vulnerabilities.db'
table_name = 'vulnerabilities'
databaseExisted = os.path.isfile(class_DB_name)
server = 'v-eam-server.database.windows.net'
database = 'Vulnerabilties'
username = 'namor'
password = 'EAM1234!'
db_con = driver.connect('DRIVER={ODBC Driver 17 for SQL Server};SERVER=' +
                        server+';DATABASE='+database+';UID='+username+';PWD=' + password)


def _close_db():
    db_con.commit()
    db_con.close()


atexit.register(_close_db)


def print_tables():
    print_table_by_name(table_name)


def delete():
    with db_con:
        cur = db_con.cursor()
        cur.execute("DROP TABLE " + table_name)


def print_table_by_name(table_name):
    with db_con:
        cur = db_con.cursor()
        cur.execute("SELECT * FROM  " + table_name)
        print(table_name)
        for row in cur.fetchall():
            print(row)


def create_tables():
    with db_con:
        cur = db_con.cursor()
        query1 = f"""
                CREATE TABLE [dbo].[vulnerabilities] (
                    {PACKAGE}	[VARCHAR](200) NOT NULL,
                    {PACKAGE_MANAGER}	[VARCHAR](200) NOT NULL,
                    {VERSION}   [VARCHAR](200) NOT NULL,
                    {FULL_PATH}	[VARCHAR](200) NOT NULL,
                    {DIRECTORY}	[VARCHAR](200) NOT NULL,
                    {FILE_NAME}	[VARCHAR](200) NOT NULL,
                    {FILE_OUTPUT}	[VARCHAR](7000) NOT NULL,
                    {MD5}	[VARCHAR](300) NOT NULL,
                    {SHA1}	[VARCHAR](300) NOT NULL,
                    {SHA256}	[VARCHAR](300) NOT NULL,
                    {B2}	[VARCHAR](300) NOT NULL,
                    {STRINGS}	[VARCHAR](7000),
                    {SECRET_KEYS}	[VARCHAR](7000),
                    {READELF}	[VARCHAR](7000),
                    {VULNERABLE_FUNC}	[VARCHAR](7000),
                    {CHECKSEC}	[VARCHAR](7000)
                    ) PRIMARY KEY (recipe_id,num); """
        query2 = f"""
                CREATE TABLE [dbo].[stringsLines] (
                    {FULL_PATH}	[VARCHAR](200) NOT NULL,
                    {LINE}    [VARCHAR](200) NOT NULL
                    );
            """

        cur.close()


def insert_text_to_stringLines(string_dict, line):
    package = string_dict[PACKAGE]
    package_manager = string_dict[PACKAGE_MANAGER]
    version = string_dict[VERSION]
    full_path = string_dict[FULL_PATH]
    print(f"adding {full_path} to strings table")
    params = ['default',package, package_manager, version, full_path, line]
    query = f"""
                INSERT INTO  stringsLines(id,{PACKAGE}, {PACKAGE_MANAGER}, {VERSION}, {FULL_PATH}, {LINE})
                VALUES (?, ?, ?, ?, ?, ?)
            """
    exec_insert(query, params)


def insert_text(entry_dict):
    package = entry_dict[PACKAGE]
    package_manager = entry_dict[PACKAGE_MANAGER]
    version = entry_dict[VERSION]
    full_path = entry_dict[FULL_PATH]
    directory = entry_dict[DIRECTORY]
    file_name = entry_dict[FILE_NAME]
    file_info_output = entry_dict[FILE_OUTPUT]
    sha1 = entry_dict[SHA1]
    sha256 = entry_dict[SHA256]
    md5 = entry_dict[MD5]
    b2 = entry_dict[B2]
    strings = entry_dict[STRINGS]
    secret_keys = str(entry_dict[SECRET_KEYS])
    print(f"adding {full_path}")
    params = [package, package_manager, version, full_path, directory, file_name, file_info_output,md5, sha1, sha256, b2, strings, secret_keys]
    query = f"""INSERT INTO vulnerabilities ({PACKAGE},{PACKAGE_MANAGER}, {VERSION}, {FULL_PATH}, {DIRECTORY},
                    {FILE_NAME}, {FILE_OUTPUT}, {MD5},
                    {SHA1}, {SHA256}, {B2}, {STRINGS}, {SECRET_KEYS})
                VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)
            """
    exec_insert(query, params)


def insert_executable(entry_dict):
    package = entry_dict[PACKAGE]
    package_manager = entry_dict[PACKAGE_MANAGER]
    version = entry_dict[VERSION]
    full_path = entry_dict[FULL_PATH]
    directory = entry_dict[DIRECTORY]
    file_name = entry_dict[FILE_NAME]
    file_info_output = entry_dict[FILE_OUTPUT]
    sha1 = entry_dict[SHA1]
    sha256 = entry_dict[SHA256]
    b2 = entry_dict[B2]
    md5 = entry_dict[MD5]
    readelf = entry_dict[READELF]
    vulnerable_functions = entry_dict[VULNERABLE_FUNC]
    checksec = entry_dict[CHECKSEC]
    print(f"adding {full_path}")
    params = [package, package_manager, version, full_path, directory, file_name, file_info_output,md5, sha1, sha256, b2, readelf, vulnerable_functions, checksec]
    query = f"""
                INSERT INTO [dbo].[vulnerabilities] ({PACKAGE}, {PACKAGE_MANAGER}, {VERSION}, {FULL_PATH}, {DIRECTORY},
                    {FILE_NAME}, {FILE_OUTPUT}, {MD5},
                    {SHA1}, {SHA256}, {B2}, {READELF}, {VULNERABLE_FUNC}, {CHECKSEC})
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
    exec_insert(query, params)


def should_check(path: str, version: str, package_name: str, package_manager: str):
    query = f"SELECT * FROM vulnerabilities WHERE {FULL_PATH} = '{path}' AND {VERSION} = '{version}' AND {PACKAGE} = '{package_name}' AND {PACKAGE_MANAGER} = '{package_manager}'"
    result = exec_query(query)
    if(len(result) == 0):
        return True
    return False


def exec_query(query, params=None):
    with db_con:
        cur = db_con.cursor()
        if params:
            cur.execute(query, *params)
        else:
            cur.execute(query)
        rows = cur.fetchall()
        cur.close()
        return rows


def exec_insert(query, params):
    with db_con:
        cur = db_con.cursor()
        cur.execute(query, *params)
        cur.close()
