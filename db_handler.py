import sqlite3
import sys
import os
import atexit

PACKAGE = "package"
FULL_PATH = "full_path"
DIRECTORY = "directory"
FILE_NAME = "file_name"
FILE_OUTPUT = "file_info_output"
MD5="md5"
SHA1 ="sha1"
SHA256 = "sha256"
B2 = "b2"
STRINGS = "strings"
READELF = "readelf"
VULNERABLE_FUNC= "vulnerable_functions"
SECRET_KEYS = "secret_keys"

class_DB_name = 'vulnerabilities.db'
table_name = 'vulnerabilities'
databaseExisted = os.path.isfile(class_DB_name)
db_con = sqlite3.connect(class_DB_name)


def _close_db():
    db_con.commit()
    db_con.close()


atexit.register(_close_db)


def print_tables():
    print_table_by_name(table_name)
    


def print_table_by_name(table_name):
    with db_con:
        cur = db_con.cursor()
        cur.execute("SELECT * FROM  " + table_name)
        print(table_name)
        for row in cur.fetchall():
            print(row)


def create_tables():
    with db_con:
        cur = db_con.cursor()
        cur.executescript("""
                CREATE TABLE IF NOT EXISTS `vulnerabilities` (
                    `package`	TEXT NOT NULL,
                    `full_path`	TEXT NOT NULL,
                    `directory`	TEXT NOT NULL,
                    `file_name`	TEXT NOT NULL,
                    `file_info_output`	TEXT NOT NULL,
                    `md5`	TEXT NOT NULL,
                    `sha1`	TEXT NOT NULL,
                    `sha256`	TEXT NOT NULL,
                    `b2`	TEXT NOT NULL,
                    `strings`	TEXT,
                    `readelf`	TEXT,
                    `vulnerable_functions`	TEXT,
                    `secret_keys`	TEXT
                    );
            """)
        cur.close()

def insert_text(entry_dict):
    package = entry_dict[PACKAGE] 
    full_path = entry_dict[FULL_PATH]
    directory = entry_dict[DIRECTORY] 
    file_name = entry_dict[FILE_NAME]
    file_info_output= entry_dict[FILE_OUTPUT]
    sha1 = entry_dict[SHA1]
    sha256 = entry_dict[SHA256]
    md5 = entry_dict[MD5]
    b2=entry_dict[B2]
    strings = entry_dict[STRINGS]
    secret_keys = str(entry_dict[SECRET_KEYS])
    print(f"adding {full_path}")
    with db_con:
        cur = db_con.cursor()
        cur.execute(f"""
                INSERT INTO vulnerabilities ({PACKAGE}, {FULL_PATH}, {DIRECTORY}, 
                    {FILE_NAME}, {FILE_OUTPUT}, {MD5}, {B2},
                    {SHA1}, {SHA256}, {STRINGS}, {SECRET_KEYS})
                VALUES (?,?,?,?,?,?,?,?,?,?)
            """, ([package, full_path, directory, file_name, file_info_output, 
                  md5, sha1, sha256,b2, strings, secret_keys]))
        cur.close()
def insert_executable(entry_dict):
    
    package = entry_dict[PACKAGE] 
    full_path = entry_dict[FULL_PATH]
    directory = entry_dict[DIRECTORY] 
    file_name = entry_dict[FILE_NAME]
    file_info_output= entry_dict[FILE_OUTPUT]
    sha1 = entry_dict[SHA1]
    sha256 = entry_dict[SHA256]
    md5 = entry_dict[MD5]
    b2 = entry_dict[B2]
    readelf = entry_dict[READELF]
    vulnerable_functions = entry_dict[VULNERABLE_FUNC]
    print(f"adding {full_path}")
    with db_con:
        cur = db_con.cursor()
        cur.execute(f"""
                INSERT INTO vulnerabilities ({PACKAGE}, {FULL_PATH}, {DIRECTORY}, 
                    {FILE_NAME}, {FILE_OUTPUT}, {MD5}, {B2},
                    {SHA1}, {SHA256}, {READELF}, {VULNERABLE_FUNC})
                VALUES (?,?,?,?,?,?,?,?,?,?)
            """, ([package, full_path, directory, file_name, file_info_output, 
            md5,b2, sha1, sha256, readelf, vulnerable_functions]))
        cur.close()