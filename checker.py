import glob, os, sys, subprocess
from csv import reader
from pathlib import Path

def check_file(path):
    temp_path = "/home/avi/Desktop/Vulnerability_Checker/temp.txt"
    obj_command = ' objdump -D ' + path +' > '+ temp_path
    subprocess.call(obj_command,shell=True)
    found_words = find_words_in_file(temp_path)
    if len(found_words)>0:
        file_dict[path] = found_words

def find_words_in_file(path):
    dump = open(path)
    found = set()
    for line in dump:
        for func_word in func_list:
            if (func_word in line):
                found.add(func_word)
    return found

func_list = [
"gets",
"strcpy",
"strcat",
"sprintf",
"scanf",
"fscanf",
"getwd",
"realpath"
]

root_directory_path = sys.argv[1]
os.chdir(root_directory_path)
file_path_list = glob.glob(root_directory_path+"/**/*.so",recursive=True)
file_dict = {}
for file in file_path_list:
    check_file(file)

print(file_dict)



## function that may be relevant at some point
def load_functions():
    # read csv file as a list of lists
    with open('../vulnerable_functions.csv', 'r') as read_obj:
        # pass the file object to reader() to get the reader object
        csv_reader = reader(read_obj)
        # Pass reader object to list() to get a list of lists
        list_of_rows = list(csv_reader)
        print(list_of_rows)
        return []

    